// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User & Authentication
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  role      UserRole @default(USER)
  status    UserStatus @default(ACTIVE)
  
  preferences Json @default("{}")
  permissions String[] @default([]) // 세분화된 권한
  
  lastLoginAt DateTime?
  blockedAt   DateTime?
  blockedReason String?
  
  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])
  
  projects         Project[]
  agentTasks       AgentTask[]
  knowledgeEntries KnowledgeEntry[]
  usageLogs        UsageLog[]
  activityLogs     ActivityLog[]
  chatSessions     ChatSession[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([status])
  @@map("users")
}

enum UserRole {
  USER
  EDITOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

// ============================================================================
// Project & Files
// ============================================================================

model Project {
  id          String  @id @default(uuid())
  name        String
  description String?
  rootPath    String  @default("")
  
  settings Json @default("{}")
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  files            File[]
  agentTasks       AgentTask[]
  snapshots        ProjectSnapshot[]
  knowledgeEntries KnowledgeEntry[]
  chatSessions     ChatSession[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("projects")
}

model File {
  id        String  @id @default(uuid())
  path      String
  name      String
  extension String  @default("")
  content   String? @db.Text
  size      Int     @default(0)
  mimeType  String?
  isDirectory Boolean @default(false)
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  versions FileVersion[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, path])
  
  // Composite indexes for file operations
  @@index([projectId])                    // List files in project
  @@index([projectId, isDirectory])       // List directories
  @@index([projectId, extension])         // Filter by extension
  @@index([projectId, updatedAt])         // Recent files
  
  @@map("files")
}

model FileVersion {
  id      String @id @default(uuid())
  version Int
  content String @db.Text
  message String?
  
  fileId String
  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  agentTaskId String?
  
  createdAt DateTime @default(now())

  // Composite indexes for version queries
  @@index([fileId])                 // All versions of file
  @@index([fileId, version])        // Specific version lookup
  @@index([fileId, createdAt])      // Recent versions
  
  @@map("file_versions")
}

model ProjectSnapshot {
  id          String  @id @default(uuid())
  name        String
  description String?
  
  fileVersionIds String[] // Array of FileVersion IDs
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  agentTaskId String?
  
  createdAt DateTime @default(now())

  // Composite indexes
  @@index([projectId])             // List snapshots in project
  @@index([projectId, createdAt])  // Recent snapshots
  
  @@map("project_snapshots")
}

// ============================================================================
// Agent & Tasks
// ============================================================================

model AgentTask {
  id       String       @id @default(uuid())
  type     AgentType
  status   AgentStatus  @default(PENDING)
  priority Int          @default(1)
  
  prompt      String   @db.Text
  context     Json     @default("{}")
  error       String?  @db.Text
  progress    Int      @default(0)
  currentStep String?
  groupId     String?

  model       String?  // Selected AI Model
  provider    String?  // Selected AI Provider
  
  // New fields for enhanced agent system
  maxSteps       Int     @default(20)   // Maximum ReAct loop iterations
  currentStepNum Int     @default(0)    // Current step number
  metadata       Json    @default("{}")  // Additional task metadata
  
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  artifacts Artifact[]
  steps     AgentStep[]    // ReAct execution steps
  memories  AgentMemory[]  // Agent memory/context
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime?
  completedAt DateTime?

  // Single column indexes
  @@index([projectId])
  @@index([groupId])
  
  // Composite indexes for common query patterns
  @@index([userId, status])           // Filter by user + status (most common)
  @@index([userId, status, createdAt]) // User tasks sorted by date
  @@index([projectId, status])        // Project tasks by status
  @@index([status, priority])         // Queue processing order
  @@index([status, createdAt])        // Recent pending tasks
  
  @@map("agent_tasks")
}

enum AgentType {
  CODE_GENERATION
  CODE_MODIFICATION
  CODE_REVIEW
  TEST_GENERATION
  REFACTORING
  BUG_FIX
  DOCUMENTATION
}

enum AgentStatus {
  PENDING
  PLANNING
  EXECUTING
  WAITING_APPROVAL
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// Agent Execution Steps (ReAct Pattern Tracking)
// ============================================================================

model AgentStep {
  id          String   @id @default(uuid())
  taskId      String
  task        AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  stepNumber  Int
  type        AgentStepType
  
  thought     String?  @db.Text   // Agent's reasoning
  toolName    String?             // Tool used
  toolInput   Json?               // Tool input arguments
  toolOutput  String?  @db.Text   // Tool output
  observation String?  @db.Text   // Agent's observation
  
  durationMs  Int      @default(0)
  error       String?
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@index([taskId, stepNumber])
  @@map("agent_steps")
}

enum AgentStepType {
  REASON
  ACT
  OBSERVE
  PLAN
  REFLECT
}

// ============================================================================
// Agent Tool Configuration
// ============================================================================

model AgentTool {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  
  isEnabled   Boolean  @default(true)
  config      Json     @default("{}")
  
  // Usage statistics
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("agent_tools")
}

// ============================================================================
// Agent Memory (Conversation & Working Memory)
// ============================================================================

model AgentMemory {
  id          String   @id @default(uuid())
  taskId      String
  task        AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  type        MemoryType
  content     String   @db.Text
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@index([taskId, type])
  @@map("agent_memories")
}

enum MemoryType {
  CONVERSATION
  WORKING
  SUMMARY
}

// ============================================================================
// Artifacts
// ============================================================================

model Artifact {
  id       String         @id @default(uuid())
  type     ArtifactType
  status   ArtifactStatus @default(DRAFT)
  
  title    String
  content  String   @db.Text
  metadata Json     @default("{}")
  
  agentTaskId String
  agentTask   AgentTask @relation(fields: [agentTaskId], references: [id], onDelete: Cascade)
  
  feedback ArtifactFeedback?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Single column index
  @@index([agentTaskId])
  
  // Composite indexes
  @@index([type, status])          // Filter by type and status
  @@index([agentTaskId, type])     // Task artifacts by type
  @@index([status, createdAt])     // Recent artifacts by status
  
  @@map("artifacts")
}

enum ArtifactType {
  PLAN
  CODE
  DIFF
  TEST_RESULT
  LOG
  SCREENSHOT
  REVIEW
  DOCUMENTATION
}

enum ArtifactStatus {
  DRAFT
  APPROVED
  REJECTED
  APPLIED
}

model ArtifactFeedback {
  id      String @id @default(uuid())
  rating  Int?
  comment String? @db.Text
  
  lineComments Json @default("[]") // Array of { line, comment, type }
  
  artifactId String   @unique
  artifact   Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@map("artifact_feedbacks")
}

// ============================================================================
// Knowledge Base (Phase 4)
// ============================================================================

model KnowledgeEntry {
  id          String @id @default(uuid())
  type        String // 'CODE_PATTERN', 'STYLE_GUIDE', 'SNIPPET', 'PROMPT_TEMPLATE'
  title       String
  description String?
  content     String @db.Text
  tags        String[]
  language    String?
  
  metadata Json @default("{}")
  
  usageCount Int @default(0)
  
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Single column indexes
  @@index([type])
  
  // Composite indexes for common query patterns
  @@index([userId, type])              // User entries by type
  @@index([userId, type, language])    // User entries by type and language
  @@index([userId, updatedAt])         // User's recent entries
  @@index([type, language, usageCount]) // Popular entries by type/language
  
  @@map("knowledge_entries")
}

// ============================================================================
// AI Model Settings
// ============================================================================

model AIModelSetting {
  id       String @id @default(uuid())
  name     String @unique
  provider String // 'ollama' | 'vllm'
  model    String
  
  settings Json @default("{}") // temperature, maxTokens, etc.
  
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)
  
  serverId String?
  server   ModelServer? @relation(fields: [serverId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_model_settings")
}

// ============================================================================
// Admin: Team Management
// ============================================================================

model Team {
  id          String @id @default(uuid())
  name        String @unique
  description String?
  
  usageLimit     Int @default(10000) // 월간 토큰 사용량 제한
  currentUsage   Int @default(0)
  
  members User[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("teams")
}

// ============================================================================
// Admin: Model Server Management
// ============================================================================

model ModelServer {
  id       String @id @default(uuid())
  name     String @unique
  type     ServerType
  url      String
  
  maxTokens    Int     @default(4096)
  device       String  @default("auto") // cuda, cpu, auto
  status       ServerStatus @default(UNKNOWN)
  lastHealthCheck DateTime?
  
  routingWeight Int @default(100) // 부하 분산 가중치
  rateLimit     Int @default(100) // 분당 요청 제한
  
  settings Json @default("{}")
  
  isActive Boolean @default(true)
  
  aiModels AIModelSetting[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("model_servers")
}

enum ServerType {
  VLLM
  OLLAMA
}

enum ServerStatus {
  ONLINE
  OFFLINE
  DEGRADED
  UNKNOWN
}

// ============================================================================
// Admin: Feature Toggles (바이브코딩 기능 제어)
// ============================================================================

model FeatureToggle {
  id          String @id @default(uuid())
  key         String @unique // smart_context, auto_fix, patch_generation
  name        String
  description String?
  
  isEnabled Boolean @default(true)
  
  settings Json @default("{}") // 기능별 세부 설정
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("feature_toggles")
}

// ============================================================================
// Admin: Prompt Template Management
// ============================================================================

model PromptTemplate {
  id          String @id @default(uuid())
  name        String @unique
  type        PromptType
  description String?
  
  content     String @db.Text
  variables   String[] // {{variable}} 형태의 변수 목록
  
  version     Int @default(1)
  isActive    Boolean @default(true)
  
  versions PromptTemplateVersion[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("prompt_templates")
}

model PromptTemplateVersion {
  id        String @id @default(uuid())
  version   Int
  content   String @db.Text
  changeLog String?
  
  templateId String
  template   PromptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())

  @@index([templateId])
  @@map("prompt_template_versions")
}

enum PromptType {
  SYSTEM
  CODE_GENERATION
  CODE_REVIEW
  BUG_FIX
  REFACTORING
  DOCUMENTATION
  CUSTOM
}

// ============================================================================
// Admin: Usage & Activity Logs
// ============================================================================

model UsageLog {
  id        String @id @default(uuid())
  
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  modelName  String
  provider   String
  feature    String // code_generation, auto_fix, explain 등
  
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  totalTokens      Int @default(0)
  
  responseTimeMs Int @default(0)
  success        Boolean @default(true)
  errorMessage   String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([modelName])
  @@index([feature])
  @@map("usage_logs")
}

model ActivityLog {
  id        String @id @default(uuid())
  
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action    String // login, logout, create_project, etc.
  resource  String? // 대상 리소스 타입
  resourceId String?
  
  ipAddress String?
  userAgent String?
  
  metadata  Json @default("{}")
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("activity_logs")
}

model SystemLog {
  id        String @id @default(uuid())
  
  level     LogLevel
  category  String // api, queue, model, system
  message   String @db.Text
  
  stackTrace String? @db.Text
  context    Json @default("{}")
  
  createdAt DateTime @default(now())

  @@index([level])
  @@index([category])
  @@index([createdAt])
  @@map("system_logs")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

// ============================================================================
// Admin: System Settings
// ============================================================================

model SystemSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json
  
  description String?
  category    String @default("general")
  
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_settings")
}

// ============================================================================
// Admin: Audit Log (관리자 감사 로그)
// ============================================================================

model AdminAuditLog {
  id        String   @id @default(uuid())
  
  adminId   String
  adminEmail String
  adminName  String
  
  action    String   // CREATE, UPDATE, DELETE, READ
  resource  String   // users, settings, servers, prompts, etc.
  resourceId String?
  
  before    Json?    // 변경 전 값
  after     Json?    // 변경 후 값
  
  ipAddress  String?
  userAgent  String?
  
  status     String @default("SUCCESS") // SUCCESS, FAILED
  errorMessage String?
  
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// ============================================================================
// Admin: Settings History (설정 변경 이력)
// ============================================================================

model SettingsHistory {
  id        String   @id @default(uuid())
  
  key       String
  category  String
  
  oldValue  Json
  newValue  Json
  
  changedById String
  changedByEmail String
  changedByName  String
  
  reason    String?  // 변경 사유
  
  createdAt DateTime @default(now())

  @@index([key])
  @@index([category])
  @@index([changedById])
  @@index([createdAt])
  @@map("settings_history")
}

// ============================================================================
// Token Cost Management: Usage Aggregation (집계 배치 시스템)
// ============================================================================

model UsageAggregation {
  id          String   @id @default(uuid())
  
  userId      String?
  teamId      String?
  
  period      AggregationPeriod
  periodStart DateTime
  periodEnd   DateTime
  
  totalTokens         Int @default(0)
  promptTokens        Int @default(0)
  completionTokens    Int @default(0)
  requestCount        Int @default(0)
  estimatedCostUsd    Decimal @default(0) @db.Decimal(10, 6)
  
  modelBreakdown      Json @default("{}") // { modelName: { tokens, cost } }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, period, periodStart])
  @@unique([teamId, period, periodStart])
  @@index([userId, periodStart])
  @@index([teamId, periodStart])
  @@index([periodStart])
  @@map("usage_aggregations")
}

enum AggregationPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

// ============================================================================
// Token Cost Management: Cost Alert (비용 알림 설정)
// ============================================================================

model CostAlert {
  id          String   @id @default(uuid())
  
  userId      String?
  teamId      String?
  
  name        String
  type        CostAlertType
  threshold   Decimal @db.Decimal(10, 2) // USD 또는 토큰 수
  period      AggregationPeriod
  
  isEnabled   Boolean @default(true)
  lastTriggeredAt DateTime?
  
  notificationChannels String[] @default(["email", "inapp"])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([teamId])
  @@index([isEnabled])
  @@map("cost_alerts")
}

enum CostAlertType {
  TOKEN_LIMIT
  COST_LIMIT
  RATE_LIMIT // 시간당 요청 수
}

// ============================================================================
// Phase 1: Advanced AI Features - Model Routing & Policies
// ============================================================================

model ModelRoutingPolicy {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  
  // 라우팅 규칙: { promptType, modelCriteria, costWeight, performanceWeight }
  rules       Json     @default("{}")
  priority    Int      @default(0)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([priority])
  @@map("model_routing_policies")
}

model CodeStylePreset {
  id          String   @id @default(uuid())
  name        String   @unique
  language    String
  
  // ESLint/Prettier config
  rules       Json     @default("{}")
  
  // Coding convention 문서
  conventions String   @db.Text
  
  teamId      String?
  isGlobal    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([language])
  @@index([teamId])
  @@index([isGlobal])
  @@map("code_style_presets")
}

model AIWorkSnapshot {
  id          String   @id @default(uuid())
  
  agentTaskId String
  stepName    String
  
  // 변경 전 상태 (파일 내용, 설정 등)
  beforeState Json     @default("{}")
  
  // 변경 후 상태
  afterState  Json     @default("{}")
  
  // 추가 메타데이터
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())

  @@index([agentTaskId])
  @@index([createdAt])
  @@map("ai_work_snapshots")
}

model PromptExecution {
  id             String   @id @default(uuid())
  
  // 사용된 템플릿 (optional)
  templateId     String?
  
  // 실제 실행된 프롬프트 내용
  promptContent  String   @db.Text
  
  // 모델 정보
  modelName      String
  provider       String
  
  // AI 응답
  response       String   @db.Text
  
  // 신뢰도 점수 (0.0 ~ 1.0)
  confidenceScore Float?
  
  // 품질 메트릭: { coherence, relevance, safety }
  qualityMetrics Json     @default("{}")
  
  // 연관된 작업
  agentTaskId    String?
  
  // 성능 메트릭
  executionTimeMs Int     @default(0)
  success        Boolean  @default(true)
  errorMessage   String?
  
  createdAt      DateTime @default(now())

  @@index([agentTaskId])
  @@index([confidenceScore])
  @@index([modelName])
  @@index([createdAt])
  @@map("prompt_executions")
}

model ConfigBackup {
  id          String   @id @default(uuid())
  
  // 백업 카테고리
  category    String   // "system_settings", "prompt_templates", "model_servers"
  
  // 전체 설정 스냅샷
  snapshot    Json     @default("{}")
  
  // 백업 생성자
  createdBy   String
  createdByEmail String?
  
  // 백업 설명
  description String?
  
  createdAt   DateTime @default(now())

  @@index([category])
  @@index([createdAt])
  @@index([createdBy])
  @@map("config_backups")
}

// ============================================================================
// AI Chat History
// ============================================================================

model ChatSession {
  id        String @id @default(uuid())
  
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  title     String @default("새 대화")
  
  // 마지막 메시지 요약 (목록 표시용)
  lastMessage String?
  
  // 세션 메타데이터
  metadata  Json @default("{}")
  
  isArchived Boolean @default(false)
  
  messages  ChatMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String @id @default(uuid())
  
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role      ChatRole
  content   String @db.Text
  
  // AI 모델 정보 (assistant 메시지인 경우)
  modelName    String?
  modelProvider String?
  
  // 토큰 사용량
  promptTokens     Int @default(0)
  completionTokens Int @default(0)
  
  // 응답 시간
  responseTimeMs   Int @default(0)
  
  // 코드 적용 여부
  codeApplied      Boolean @default(false)
  appliedFilePath  String?
  
  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

enum ChatRole {
  system
  user
  assistant
}
